{
  "project": "tg-agent",
  "version": "2.0.0",
  "last_updated": "2026-02-21T06:45:00Z",
  "current_focus": null,
  "tasks": [
    {
      "id": "V2-001",
      "title": "Project setup and scaffolding",
      "description": "Initialize TypeScript project with proper structure, dependencies, and build configuration",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-02-21T03:25:00Z",
      "dependencies": [],
      "steps": [
        "Initialize package.json with dependencies (express, ioredis, @modelcontextprotocol/sdk)",
        "Setup TypeScript with strict mode",
        "Create src/ folder structure (gateway/, mcp/, inbox/, utils/)",
        "Add build and dev scripts",
        "Setup environment config (.env.example)"
      ],
      "files": ["package.json", "tsconfig.json", ".env.example", "src/index.ts"]
    },
    {
      "id": "V2-002",
      "title": "Redis inbox module",
      "description": "Create Redis Streams inbox client with consumer group support",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-02-21T03:35:00Z",
      "dependencies": ["V2-001"],
      "steps": [
        "Create InboxClient class with ioredis",
        "Implement addMessage (XADD with dedupe)",
        "Implement getMessages (XREADGROUP with long-poll)",
        "Implement ackMessages (XACK)",
        "Implement setupConsumerGroup (XGROUP CREATE)",
        "Add 12-hour lease reclaim logic (XCLAIM)"
      ],
      "files": ["src/inbox/client.ts", "src/inbox/types.ts"]
    },
    {
      "id": "V2-003",
      "title": "Telegram API client",
      "description": "Create Telegram Bot API client for sending messages",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-02-21T03:35:00Z",
      "dependencies": ["V2-001"],
      "steps": [
        "Create TelegramClient class with fetch-based API calls",
        "Implement sendMessage with retry logic",
        "Implement sendChatAction (typing indicator)",
        "Add markdown escaping utility (MarkdownV2)",
        "Add message chunking utility (4000 char limit)"
      ],
      "files": ["src/telegram/client.ts", "src/telegram/chunk.ts", "src/telegram/escape.ts"]
    },
    {
      "id": "V2-004",
      "title": "Gateway webhook server",
      "description": "Create Express server to receive Telegram webhooks and write to inbox",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-02-21T03:40:00Z",
      "dependencies": ["V2-002"],
      "steps": [
        "Create Express server with /telegram/webhook endpoint",
        "Validate webhook signature (if enabled)",
        "Parse Telegram Update object",
        "Call inbox.addMessage with dedupe",
        "Add allowlist validation for authorized users",
        "Add health check endpoint"
      ],
      "files": ["src/gateway/server.ts", "src/gateway/routes/webhook.ts"]
    },
    {
      "id": "V2-005",
      "title": "MCP Server - telegram_poll tool",
      "description": "Implement MCP tool for polling messages from inbox",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-02-21T03:40:00Z",
      "dependencies": ["V2-002"],
      "steps": [
        "Create MCP server with @modelcontextprotocol/sdk",
        "Implement telegram_poll tool with timeout and limit params",
        "Return messages with combined_context",
        "Messages claimed on poll (not acked yet)"
      ],
      "files": ["src/mcp/server.ts", "src/mcp/tools/poll.ts"]
    },
    {
      "id": "V2-006",
      "title": "MCP Server - telegram_send tool",
      "description": "Implement MCP tool for sending messages to Telegram",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-02-21T03:40:00Z",
      "dependencies": ["V2-003", "V2-005"],
      "steps": [
        "Implement telegram_send tool",
        "Integrate chunking utility",
        "Integrate markdown escaping",
        "Return success with message_id and chunks_sent"
      ],
      "files": ["src/mcp/tools/send.ts"]
    },
    {
      "id": "V2-007",
      "title": "MCP Server - telegram_ack tool",
      "description": "Implement MCP tool for acknowledging processed messages",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-02-21T03:40:00Z",
      "dependencies": ["V2-005"],
      "steps": [
        "Implement telegram_ack tool",
        "Accept array of message_ids",
        "Call inbox.ackMessages",
        "Return count of acked messages"
      ],
      "files": ["src/mcp/tools/ack.ts"]
    },
    {
      "id": "V2-008",
      "title": "MCP Server - telegram_send_typing tool",
      "description": "Implement MCP tool for showing typing indicator",
      "priority": "P1",
      "status": "completed",
      "completedAt": "2026-02-21T03:40:00Z",
      "dependencies": ["V2-003"],
      "steps": [
        "Implement telegram_send_typing tool",
        "Call TelegramClient.sendChatAction"
      ],
      "files": ["src/mcp/tools/typing.ts"]
    },
    {
      "id": "V2-009",
      "title": "Entry point and process management",
      "description": "Create main entry point that runs both Gateway and MCP Server",
      "priority": "P0",
      "status": "completed",
      "completedAt": "2026-02-21T03:48:00Z",
      "dependencies": ["V2-004", "V2-005", "V2-006", "V2-007"],
      "steps": [
        "Create src/index.ts as main entry",
        "Support running gateway-only mode (--gateway)",
        "Support running MCP-only mode (--mcp)",
        "Default: run both",
        "Add graceful shutdown handling"
      ],
      "files": ["src/index.ts", "src/process.ts"]
    },
    {
      "id": "V2-010",
      "title": "Configuration and environment",
      "description": "Create configuration module for environment variables and settings",
      "priority": "P1",
      "status": "completed",
      "completedAt": "2026-02-21T03:25:00Z",
      "dependencies": ["V2-001"],
      "steps": [
        "Create src/config/index.ts with typed config",
        "Load from .env with defaults",
        "Validate required vars on startup",
        "Document all config options"
      ],
      "files": ["src/config/index.ts"]
    },
    {
      "id": "V2-011",
      "title": "Integration testing",
      "description": "Create end-to-end tests for the complete flow",
      "priority": "P1",
      "status": "completed",
      "completedAt": "2026-02-21T03:52:00Z",
      "dependencies": ["V2-009"],
      "steps": [
        "Setup vitest for testing",
        "Create mock Telegram API server",
        "Test webhook â†’ inbox flow",
        "Test MCP poll â†’ send â†’ ack flow",
        "Test chunking behavior",
        "Test deduplication"
      ],
      "files": ["tests/integration/*.test.ts"]
    },
    {
      "id": "V2-012",
      "title": "Documentation and README",
      "description": "Create user documentation for tg-agent v2",
      "priority": "P2",
      "status": "completed",
      "completedAt": "2026-02-21T03:56:00Z",
      "dependencies": ["V2-009"],
      "steps": [
        "Update README.md with v2 architecture",
        "Document MCP tools usage",
        "Document configuration options",
        "Add setup guide",
        "Add Claude Code integration guide"
      ],
      "files": ["README.md", "docs/setup.md", "docs/mcp-tools.md"]
    },
    {
      "id": "V2-013",
      "title": "Tmux wake-up injection",
      "description": "Implement tmux keystroke injection in gateway to wake up Claude Code when Telegram messages arrive. This completes the wake-up mechanism for v2.",
      "priority": "P1",
      "status": "completed",
      "completedAt": "2026-02-21T06:27:00Z",
      "dependencies": ["V2-004"],
      "steps": [
        "Create src/gateway/tmux-injector.ts module",
        "Detect if Claude Code is running in a tmux session",
        "Implement keystroke injection using tmux send-keys",
        "Add configurable tmux session name (TMUX_SESSION_NAME env var)",
        "Add enable/disable flag (auto-enable if TMUX_SESSION_NAME is set)",
        "Integrate injector into webhook handler after message saved to inbox",
        "Add Telegram error notification on injection failure",
        "Update .env.example with new config options"
      ],
      "files": ["src/gateway/tmux-injector.ts", "src/gateway/server.ts", "src/config/index.ts", ".env.example"],
      "notes": "Injects /mcp tg-agent:telegram_poll command. Auto-enabled when TMUX_SESSION_NAME is set."
    },
    {
      "id": "V2-014",
      "title": "Response hook for auto-send",
      "description": "Implement Claude Code hook that automatically sends responses to Telegram when Claude Code completes a response or task.",
      "priority": "P1",
      "status": "pending",
      "dependencies": ["V2-006", "V2-013"],
      "steps": [
        "Research Claude Code hook system (Stop hook, Notification hook)",
        "Create hooks/ directory for Claude Code hooks",
        "Implement response capture mechanism",
        "Create hook script that calls telegram_send with response content",
        "Handle markdown formatting for Telegram (MarkdownV2 escaping)",
        "Add configuration for hook enable/disable",
        "Test hook integration with Claude Code",
        "Document hook setup in README"
      ],
      "files": ["hooks/response-hook.sh", "hooks/response-hook.ts", ".claude/settings.json", "README.md"],
      "notes": "May need to use Claude Code's Stop hook or Notification hook API"
    },
    {
      "id": "V2-015",
      "title": "Approval and choice handling",
      "description": "Implement mechanism to handle Claude Code's approval requests and choice selections via Telegram. Allows remote user to approve/reject actions or select options.",
      "priority": "P1",
      "status": "pending",
      "dependencies": ["V2-014"],
      "steps": [
        "Research Claude Code approval/choice prompt format",
        "Design Telegram-based approval flow",
        "Create MCP tool for sending approval requests (telegram_ask)",
        "Create MCP tool for waiting on user response (telegram_wait_response)",
        "Implement timeout handling for approvals",
        "Handle choice selection (numbered options)",
        "Add inline keyboard support for quick approvals (optional)",
        "Test approval flow end-to-end",
        "Document approval workflow"
      ],
      "files": ["src/mcp/tools/ask.ts", "src/mcp/tools/wait.ts", "src/telegram/keyboard.ts"],
      "notes": "Consider Telegram inline keyboards for yes/no approvals: [Approve] [Reject]"
    },
    {
      "id": "V2-016",
      "title": "Gateway typing indicator and reaction feedback",
      "description": "Gateway should send typing indicator to Telegram chat when message arrives, and add a reaction (ðŸ‘€) to the original message. When message is acknowledged via telegram_ack, update the reaction to âœ… to show it was processed.",
      "priority": "P1",
      "status": "pending",
      "dependencies": ["V2-004", "V2-007"],
      "steps": [
        "Add setMessageReaction method to TelegramClient (Telegram Bot API)",
        "Store original message_id in inbox when saving to Redis",
        "Gateway: send typing indicator when webhook receives message",
        "Gateway: add ðŸ‘€ reaction to original message when saved to inbox",
        "MCP ack tool: call reaction update to âœ… after successful ack",
        "Add reaction config options (REACTION_PENDING, REACTION_ACKED)",
        "Update .env.example with new config options",
        "Test full flow: message â†’ typing â†’ ðŸ‘€ â†’ ack â†’ âœ…"
      ],
      "files": ["src/telegram/client.ts", "src/gateway/server.ts", "src/mcp/tools/ack.ts", "src/inbox/client.ts", ".env.example"],
      "notes": "Requires Telegram Bot API setMessageReaction endpoint. Need to store chat_id + message_id mapping in Redis inbox."
    },
    {
      "id": "V2-017",
      "title": "Multi-session/Multi-bot support",
      "description": "Support multiple Telegram bots, each connected to a different tmux session/project. Reflects dev-workspace methodology where multiple Claude Code sessions work on different projects. Core idea: include bot_id in Redis messages and upgrade telegram_poll to filter by bot/session.",
      "priority": "P2",
      "status": "pending",
      "dependencies": ["V2-013", "V2-016"],
      "steps": [
        "Brainstorm architecture: per-bot config vs single gateway routing",
        "Design Redis inbox schema changes (add bot_id field)",
        "Design telegram_poll filter by bot_id/session",
        "Design multi-gateway setup (one per bot) vs single gateway multi-tenant",
        "Implement bot_id in webhook handler and inbox storage",
        "Update telegram_poll to accept bot_id filter parameter",
        "Update telegram_send to route to correct bot",
        "Update tmux injector to target correct session per bot",
        "Add bots.json config for multi-bot setup",
        "Test multi-bot scenario: 2 bots, 2 sessions, isolated messaging"
      ],
      "files": ["src/config/index.ts", "src/gateway/server.ts", "src/inbox/client.ts", "src/mcp/tools/poll.ts", "src/mcp/tools/send.ts", "src/gateway/tmux-injector.ts", "config/bots.json"],
      "notes": "Key design question: single gateway routing multiple bots vs separate gateway per bot. Consider dev-workspace session/project mapping."
    },
    {
      "id": "V2-018",
      "title": "Media and file support",
      "description": "Enable sending photos and files via Telegram for Claude Code to analyze. Gateway should handle photo/document updates, download media via Telegram API, and include media metadata/URL in inbox messages. Claude can then analyze images using vision capabilities.",
      "priority": "P1",
      "status": "pending",
      "dependencies": ["V2-004"],
      "steps": [
        "Update TelegramUpdate type to include photo/document fields",
        "Add getFile method to TelegramClient for downloading media",
        "Gateway: detect photo/document in webhook payload",
        "Gateway: get file_path via Telegram API, construct download URL",
        "Inbox: store media_type, file_id, file_url in message metadata",
        "telegram_poll: include media info in response (url, type, dimensions)",
        "Handle multiple photos (albums) - send as array",
        "Handle documents (PDFs, code files) - include filename, mime_type",
        "Test: send photo from Telegram, verify Claude receives URL"
      ],
      "files": ["src/telegram/client.ts", "src/gateway/server.ts", "src/inbox/client.ts", "src/inbox/types.ts", "src/mcp/tools/poll.ts"],
      "notes": "Telegram photos have multiple sizes. Use the largest. Files expire after ~1 hour if not downloaded - consider caching or immediate download."
    },
    {
      "id": "V2-019",
      "title": "Session context clearing",
      "description": "Add ability to clear/reset context for a running Claude Code session via Telegram command. Useful for starting fresh without restarting the entire session.",
      "priority": "P2",
      "status": "pending",
      "dependencies": ["V2-004"],
      "steps": [
        "Design clear context mechanism (MCP tool? Special command?)",
        "Option A: MCP tool telegram_clear_context that signals Claude",
        "Option B: Special message pattern that Claude interprets as clear",
        "Option C: Hook that injects /compact or similar into tmux",
        "Implement chosen approach",
        "Add confirmation reaction or message when context cleared",
        "Document usage: send '/clear' or '/reset' via Telegram",
        "Test: verify context is cleared without breaking session"
      ],
      "files": ["src/mcp/tools/clear.ts", "src/gateway/server.ts", "src/gateway/tmux-injector.ts"],
      "notes": "Consider Claude Code's native /compact command. May need to inject keystroke into tmux to trigger built-in context management."
    }
  ],
  "phases": [
    {
      "name": "Foundation",
      "tasks": ["V2-001", "V2-002", "V2-003", "V2-010"],
      "description": "Core modules and utilities"
    },
    {
      "name": "Gateway",
      "tasks": ["V2-004"],
      "description": "Webhook receiver"
    },
    {
      "name": "MCP Server",
      "tasks": ["V2-005", "V2-006", "V2-007", "V2-008"],
      "description": "MCP tools implementation"
    },
    {
      "name": "Integration",
      "tasks": ["V2-009", "V2-011"],
      "description": "Entry point and testing"
    },
    {
      "name": "Docs",
      "tasks": ["V2-012"],
      "description": "Documentation"
    },
    {
      "name": "Wake-up",
      "tasks": ["V2-013"],
      "description": "Tmux injection for Claude Code wake-up"
    },
    {
      "name": "Hooks",
      "tasks": ["V2-014", "V2-015"],
      "description": "Response and approval hooks for Telegram integration"
    },
    {
      "name": "UX Feedback",
      "tasks": ["V2-016"],
      "description": "Typing indicators and reaction-based message status"
    },
    {
      "name": "Multi-tenancy",
      "tasks": ["V2-017"],
      "description": "Multi-bot/multi-session support for parallel projects"
    },
    {
      "name": "Media",
      "tasks": ["V2-018"],
      "description": "Photo and file support for visual analysis"
    },
    {
      "name": "Session Management",
      "tasks": ["V2-019"],
      "description": "Context clearing and session control"
    }
  ]
}
